{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3 class="card-title mb-0">
                <i class="fas fa-chart-bar me-2"></i>Task Duration Analysis
            </h3>
        </div>
        <div class="card-body p-4">
            <div class="row g-4">
                {% for status_code, data in status_data.items %}
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center status-header-{{ status_code }}">
                            <h5 class="mb-0 text-white">{{ data.name }}</h5>
                            <span class="badge bg-light text-dark">{{ data.count }}</span>
                        </div>
                        <div class="card-body p-3">
                            {% if data.tasks %}
                                <div class="duration-chart">
                                    {% for task in data.tasks %}
                                    <div class="task-bar mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-truncate me-2 task-title task-title-{{ forloop.counter0|add:1 }}" title="{{ task.title }}">{{ task.title|truncatechars:20 }}</small>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">Total days:</small>
                                            <small class="text-muted fw-bold">{{ task.duration }} days</small>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">Time remaining:</small>
                                            <small class="text-muted fw-bold time-remaining-display">Calculating...</small>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">Progress:</small>
                                            <small class="text-muted fw-bold progress-display">Calculating...</small>
                                        </div>
                                        <div class="progress" style="height: 12px;">
                                            <div class="progress-bar" 
                                                 role="progressbar" 
                                                 data-duration="{{ task.duration }}"
                                                 data-start-date="{{ task.start_date }}"
                                                 data-end-date="{{ task.end_date }}"
                                                 title="{{ task.title }} - {{ task.duration }} days">
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2"></i>
                                    <p class="mb-0">No tasks in this status</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
.duration-chart {
    max-height: 400px;
    overflow-y: auto;
}

.task-bar {
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 8px;
}

.task-bar:last-child {
    border-bottom: none;
}

.progress {
    background-color: #e9ecef;
    border-radius: 6px;
}

.progress-bar {
    transition: width 0.3s ease;
    border-radius: 6px;
}

/* Color variations for different completion statuses */
.progress-bar.not-started {
    background-color: #6c757d;
}

.progress-bar.just-started {
    background-color: #dc3545;
}

.progress-bar.in-progress {
    background-color: #fd7e14;
}

.progress-bar.almost-done {
    background-color: #ffc107;
}

.progress-bar.nearly-complete {
    background-color: #20c997;
}

.progress-bar.completed {
    background-color: #198754;
}

.badge {
    font-weight: 500;
}

/* Status header colors */
.status-header-not_started {
    background-color: #6c757d;
}

.status-header-working {
    background-color: #0d6efd;
}

.status-header-stuck {
    background-color: #dc3545;
}

.status-header-done {
    background-color: #198754;
}

/* Task title colors - cycling through 4 colors */
.task-title-1 {
    color: #e74c3c;
    font-weight: 600;
}

.task-title-2 {
    color: #3498db;
    font-weight: 600;
}

.task-title-3 {
    color: #f39c12;
    font-weight: 600;
}

.task-title-4 {
    color: #9b59b6;
    font-weight: 600;
}

.task-title-5 {
    color: #e74c3c;
    font-weight: 600;
}

.task-title-6 {
    color: #3498db;
    font-weight: 600;
}

.task-title-7 {
    color: #f39c12;
    font-weight: 600;
}

.task-title-8 {
    color: #9b59b6;
    font-weight: 600;
}

/* Custom scrollbar for duration chart */
.duration-chart::-webkit-scrollbar {
    width: 6px;
}

.duration-chart::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.duration-chart::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.duration-chart::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set progress bar widths, colors, and calculate time remaining
    const progressBars = document.querySelectorAll('.progress-bar[data-duration]');
    
    progressBars.forEach(function(bar, index) {
        const duration = parseInt(bar.getAttribute('data-duration'));
        const startDate = new Date(bar.getAttribute('data-start-date'));
        const endDate = new Date(bar.getAttribute('data-end-date'));
        const today = new Date();
        
        // Calculate time remaining percentage
        const totalDuration = endDate - startDate;
        const elapsed = today - startDate;
        const remaining = endDate - today;
        
        let percentile = 0;
        let timeRemainingText = '';
        let progressText = '';
        
        if (today < startDate) {
            // Task hasn't started yet
            percentile = 0;
            const daysUntilStart = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
            timeRemainingText = `${daysUntilStart} days until start`;
            progressText = '0% done';
        } else if (today > endDate) {
            // Task is overdue
            percentile = 100;
            const daysOverdue = Math.ceil((today - endDate) / (1000 * 60 * 60 * 24));
            timeRemainingText = `${daysOverdue} days overdue`;
            progressText = '100% done';
        } else {
            // Task is in progress
            percentile = Math.round((elapsed / totalDuration) * 100);
            const daysRemaining = Math.ceil(remaining / (1000 * 60 * 60 * 24));
            timeRemainingText = `${daysRemaining} days left`;
            progressText = `${percentile}% done`;
        }
        
        // Update the displays for this specific task bar
        const taskBar = bar.closest('.task-bar');
        const timeRemainingElement = taskBar.querySelector('.time-remaining-display');
        const progressElement = taskBar.querySelector('.progress-display');
        
        if (timeRemainingElement) {
            timeRemainingElement.textContent = timeRemainingText;
        }
        if (progressElement) {
            progressElement.textContent = progressText;
        }
        
        // Set the progress bar width based on actual completion percentage
        bar.style.width = percentile + '%';
        
        // Add color class based on completion status
        if (percentile === 0) {
            bar.classList.add('not-started');
        } else if (percentile < 25) {
            bar.classList.add('just-started');
        } else if (percentile < 50) {
            bar.classList.add('in-progress');
        } else if (percentile < 75) {
            bar.classList.add('almost-done');
        } else if (percentile < 100) {
            bar.classList.add('nearly-complete');
        } else {
            bar.classList.add('completed');
        }
    });
});
</script>
{% endblock %}